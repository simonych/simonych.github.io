<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
    <link rel="stylesheet" href="iui/iui.css" type="text/css" />
    <link rel="stylesheet" href="iui/t/default/default-theme.css" type="text/css" />
    <!--- link rel="stylesheet" href="iui/ext-sandbox/t/android/android-theme.css" type="text/css"/ --->
    <script type="application/x-javascript" src="iui/iui.js"></script>

    <style type="text/css">
        pre {
            padding: 10px;
            white-space: pre-wrap;
            /* css-3 */
            white-space: -moz-pre-wrap;
            /* Mozilla, с 1999 */
            white-space: -pre-wrap;
            /* Opera 4-6 */
            white-space: -o-pre-wrap;
            /* Opera 7 */
            word-wrap: break-word;
            /* Internet Explorer 5.5+ поддерживается в IE, Safari, и Firefox 3.1.*/
        }

        audio {
            background-color: #000000;
        }
    </style>

    <title>Матрица</title>

    <!--- Start IOS code --->
    <meta name="apple-mobile-web-app-capable" content="yes" />

    <meta name="apple-mobile-web-app-status-bar-style" content="black" />

    <style type="text/css">
        #appModeNote {
            background-color: #333333;
            border-top: 5px solid #000000;
            bottom: 0px;
            color: #F0F0F0;
            display: none;
            font-family: helvetica;
            left: 0px;
            padding: 10px 0px 10px 0px;
            position: fixed;
            text-align: center;
            width: 100%;
        }

        #appModeNote em {
            display: block;
            font-size: 20px;
            font-weight: bold;
            line-height: 20px;
        }

        #appModeNote span {
            display: block;
            font-size: 14px;
            line-height: 20px;
        }

        .playButton {
            color: white;
            background-color: transparent;
            font-size: 28px;
            position: relative;
            border: none;
            width: 100px;
            text-shadow: -1px 0 black, 0 1px black, 1px 0 black, 0 -1px black;
        }
    </style>

    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>

    <script type="text/javascript">
        var flag = false;

        $(function() {
            var appModeNote = $("#appModeNote");
            var body = $(document.body);
            if (
                ("standalone" in window.navigator) &&
                !window.navigator.standalone
            ) {
                appModeNote.show();
                body.bind(
                    "touchstart.appModeNote touchmove.appModeNote",
                    function(event) {
                        event.preventDefault();
                        body.unbind("touchstart.appModeNote touchmove.appModeNote");
                        appModeNote.fadeOut(500);
                    }
                );
            }

            //+ cache
            try {
                var cache = localStorage.getItem('cache');
                if (cache) {
                    $('body').html(cache);
	            return;
                }
            } catch(err) {
                console.log("CACHE ERROR: " + err);
            }
            //- cache

            // В конец странички докидываю все AUDIO
            for (i = 1; i <= 40; i++) {
                var audio = document.createElement('audio');
                if (i < 10) {
                    i = "0" + i;
                }
                audio.id = i;
                audio.src = "mp3/lesson-" + i + ".mp3";
                audio.preload = "none";
                audio.loop = "true";
                document.body.appendChild(audio);
            }

            // Формирую список уроков
            var list = document.getElementById("screen00");
            for (i = 1; i <= 40; i++) {
                if (i < 10) {
                    i = "0" + i;
                }

                var li = document.createElement('li');

                var div = $('<div id="screen'+i+'" class="panel" />');

                $.ajax({
                    url: 'text/' + i + '.txt',
                    type: 'get',
                    async: false,
                    success: function(response) {
                        var result = response.split("\n");
                        div.attr('title', result[0]);
                        var vieldset = "";
                        for (j = 1; j < result.length; j++) {
                            vieldset += result[j] + "\n";
                        }
                        div.append("<fieldset><pre>" + vieldset + "</pre></fieldset><button class=\"playButton\" onclick=\"play('" + i + "')\"></button><br/>");
                        li.innerHTML = '<a href="#screen' + i + '">' + result[0] + '</a><button class="playButton" onclick="play(\'' + i + '\')"></button><br/>';
                    }
                });
                list.appendChild(li);
                $('body').append(div);
            }

            // Всем кнопкам назначаю ">>"
            $(".playButton").text(" >> ");

	    //+ cache
            localStorage.setItem('cache', $('body').html());
            //- cache
        });

        function play(audioId) {
            console.log('audioId: ' + audioId);
            $("audio").each(function(index) {
                this.pause();
            });
            if (flag) {
                $("button").text(" >> ");
            } else {
                document.getElementById(audioId).play();
                $("button").text(" || ");
            }
            flag = !flag;
        };
    </script>
    <!--- End IOS code --->
</head>
<body>
    <div class="toolbar">
        <h1 id="pageTitle"></h1>
        <a id="backButton" class="button" href="#"></a>
    </div>

    <ul id="screen00" title="Матрица" selected="true"></ul>
</body>
</html>
